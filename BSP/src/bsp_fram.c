/*
*********************************************************************************************************
* @file    	bsp_fram.c
* @author  	SY
* @version 	V1.0.0
* @date    	2018-5-16 13:03:14
* @IDE	 	Keil V4.72.10.0
* @Chip    	STM32F407VE
* @brief   	铁电存储器源文件
*********************************************************************************************************
* @attention
*		
* 
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                              				Private Includes
*********************************************************************************************************
*/
#include "bsp.h"


/*
*********************************************************************************************************
*                              				Private define
*********************************************************************************************************
*/
#define	WR_24C16_ADD			0xA0
#define	RD_24C16_ADD			0xA1

#define I2C_DEVx				(DEV_I2C5)					
									
/*
*********************************************************************************************************
*                              				Private typedef
*********************************************************************************************************
*/


/*
*********************************************************************************************************
*                              				Private constants
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                              				Private macro
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                              				Private function prototypes
*********************************************************************************************************
*/


/*
*********************************************************************************************************
*                              				Private variables
*********************************************************************************************************
*/


/*
*********************************************************************************************************
*                              				Private functions
*********************************************************************************************************
*/
/*
*********************************************************************************************************
* Function Name : bsp_InitFram
* Description	: 铁电存储器初始化
* Input			: None
* Output		: None
* Return		: None
*********************************************************************************************************
*/
void bsp_InitFram(void)
{
	if (bsp_FramCheckOk(I2C_DEVx)) {
		ECHO(DEBUG_BSP_INIT, "[BSP] 铁电存储器 初始化 .......... OK");
	} else {
		ECHO(DEBUG_BSP_INIT, "[BSP] 铁电存储器 初始化 .......... ERR");
	}
}

/*
*********************************************************************************************************
* Function Name : bsp_FramCheckOk
* Description	: 判断FRAM是否正常
* Input			: None
* Output		: None
* Return		: None
*********************************************************************************************************
*/
bool bsp_FramCheckOk(I2C_DevEnum dev)
{
	if (bsp_I2CCheckDevice(dev, WR_24C16_ADD))
	{
		return true;
	}
	else
	{
		/* 失败后，切记发送I2C总线停止信号 */
		bsp_I2CStop(dev);
		return false;
	}
}

/*
*********************************************************************************************************
* Function Name : bsp_Fm24WriteBytes
* Description	: 写字节
* Input			: None
* Output		: None
* Return		: None
*********************************************************************************************************
*/
bool bsp_FramWriteBytes(uint8_t* dat, uint16_t addr, uint16_t len)
{
	bsp_I2CStart(I2C_DEVx);								
	bsp_I2CSendByte(I2C_DEVx, WR_24C16_ADD|((addr>>7)&0x0E));
	bsp_I2CWaitAck(I2C_DEVx);
	bsp_I2CSendByte(I2C_DEVx, (uint8_t)((addr)&0xff));
	bsp_I2CWaitAck(I2C_DEVx);
	for (uint16_t i=0;i<len;i++)				
	{
		bsp_I2CSendByte(I2C_DEVx, *(dat+i));
		bsp_I2CWaitAck(I2C_DEVx);              
	}
	bsp_I2CStop(I2C_DEVx);
	return true;
}

/*
*********************************************************************************************************
* Function Name : bsp_Fm24ReadBytes
* Description	: 读字节
* Input			: None
* Output		: None
* Return		: None
*********************************************************************************************************
*/
bool bsp_FramReadBytes(uint8_t *p, uint16_t addr,uint16_t len)
{
	uint16_t i;
	bsp_I2CStart(I2C_DEVx);									//启动I2C
	bsp_I2CSendByte(I2C_DEVx, WR_24C16_ADD|((addr>>7)&0x0E));	//发送器件地址
	bsp_I2CWaitAck(I2C_DEVx);
	bsp_I2CSendByte(I2C_DEVx, (uint8_t)((addr)&0xff));
	bsp_I2CWaitAck(I2C_DEVx);        
	bsp_I2CStart(I2C_DEVx);
	bsp_I2CSendByte(I2C_DEVx, RD_24C16_ADD|((addr>>7)&0x0E));
	bsp_I2CWaitAck(I2C_DEVx);	
	for(i=0;i<len-1;i++) 			//读取字节数据
	{
		*(p+i)=bsp_I2CReadByte(I2C_DEVx);	//读取数据
		bsp_I2CAck(I2C_DEVx);
	}
	*(p+len-1)=bsp_I2CReadByte(I2C_DEVx);
	bsp_I2CnAck(I2C_DEVx);
	bsp_I2CStop(I2C_DEVx);
	return true;
}




/************************ (C) COPYRIGHT STMicroelectronics **********END OF FILE*************************/
